(()=>{"use strict";let e=[],t=0,o=400,n=540,i=[],r=0,s={KOOL:50,COOL:100,GOOD:150,MISS:200},a=()=>{let n=Date.now(),a=!1,c=null;e=e.map(e=>{if(e.isStuck)return e;let o=(n-e.thrownAt)/1e3,l=Math.min(1,o/.3);if(250-l*(2-l)*(250-t)<=t){let t=(e=>{if(0===i.length)return null;let t=null,o=1/0;for(let n of i){let i=e-n.time,r=Math.abs(i);r<=s.MISS&&r<o&&(o=r,t={note:n,timingError:i})}return t})(r);if(t){let e=(e=>{let t=Math.abs(e);return t<=s.KOOL?"KOOL":t<=s.COOL?"COOL":t<=s.GOOD?"GOOD":"MISS"})(t.timingError);c={hitTime:r/1e3,timingError:t.timingError,judgment:e,noteId:t.note.noteId,accuracy:Math.max(0,100-Math.abs(t.timingError)/s.MISS*100)},console.log("[physics.worker] Hit judgment: ".concat(e,", timing error: ").concat(t.timingError,"ms, game time: ").concat(r,"ms, accuracy: ").concat(c.accuracy.toFixed(1),"%"))}else c={hitTime:r/1e3,timingError:999,judgment:"MISS",noteId:null,accuracy:0},console.log("[physics.worker] Hit but no note available - MISS, game time:",r);return a=!0,{...e,isStuck:!0,stuckAngle:90-n/1e3*120%360}}return e}).filter(e=>n-e.thrownAt<5e3),a&&c&&self.postMessage({type:"HIT",payload:c});let l=e.map(e=>({...e,position:(e=>{let n=Date.now(),i=(n-e.thrownAt)/1e3;if(e.isStuck){let o=n/1e3*120%360+e.stuckAngle,i=o*Math.PI/180,r=t+32-10,s=Math.cos(i)*r;return{x:s,y:Math.sin(i)*r,rotation:o+-90}}return{x:0,y:250-i*o,rotation:0}})(e)}));self.postMessage({type:"UPDATE",payload:{knives:l}})};self.onmessage=c=>{let{type:l,payload:g}=c.data;switch(console.log("[physics.worker] Received message:",l,g),l){case"INIT":t=g.targetRadius,o=g.velocity,n=g.rotationSpeed,console.log("[physics.worker] Initialized with:",{targetRadius:t,velocity:o,rotationSpeed:n}),setInterval(a,1e3/60);break;case"THROW":console.log("[physics.worker] Adding knife:",g.knife),e.push(g.knife);break;case"SET_NOTES":console.log("[physics.worker] Setting active notes:",g.notes.length),i=g.notes.map((e,t)=>({time:e.time,noteId:"note-".concat(t,"-").concat(e.time)}));break;case"SET_JUDGMENT_WINDOWS":console.log("[physics.worker] Setting judgment windows:",g.windows),s={...g.windows};break;case"UPDATE_GAME_TIME":r=g.gameTime;break;case"RESET":console.log("[physics.worker] Resetting knives and notes"),e=[],i=[],r=0}}})(),_N_E={};